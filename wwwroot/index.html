<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <!-- Viewport + safe-area per iPhone -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Lupus in Tabula</title>

    <!-- Font + SignalR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <style>
        /* ======================= THEME / VARIABILI ======================= */
        :root {
            --brand: #8b0000;
            --brand-2: #b22222;
            --ok: #4a90e2;
            --warn: #f39c12;
            --bg: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --ring: rgba(139,0,0,.35);
            --card: rgba(255,255,255,.7);
            --lead: #FDE68A;
            --tie: #FEF3C7;
            --lead-accent: #F59E0B;
            --tie-accent: #FBBF24;
            /* safe-area iOS */
            --sa-left: env(safe-area-inset-left,0px);
            --sa-right: env(safe-area-inset-right,0px);
            --sa-balanced: max(env(safe-area-inset-left,0px), env(safe-area-inset-right,0px));
        }

        /* =================== MOBILE: CENTRATURA & NO PAN-X =================== */
        html, body {
            width: 100%;
            max-width: 100%;
            height: 100%;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        img, video, canvas {
            max-width: 100%;
            height: auto;
        }

        /* ======================= RESET BASE / TIPOGRAFIA ======================= */
        * {
            box-sizing: border-box
        }

        body {
            font-family: "Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            margin: 0;
            color: var(--text);
            background: radial-gradient(1200px 800px at 80% -10%, #ffd0c2 0%, transparent 60%), radial-gradient(1000px 700px at -10% 90%, #ffe9b0 0%, transparent 60%), linear-gradient(135deg,#fff7f3 0%,#ffe9e3 35%,#fff6e6 100%);
            min-height: 100svh;
            display: grid;
            place-items: stretch;
        }

        h1, h2, h3 {
            margin: 0 0 8px
        }

        /* ============================ CONTROLLI ============================ */
        input, button {
            font-family: inherit;
            font-size: 16px;
            border-radius: 12px;
            border: 1.5px solid var(--border);
            padding: 12px 14px;
            transition: box-shadow .2s,transform .04s,background-color .2s,border-color .2s;
        }

        input {
            background: #fff
        }

            input:focus {
                outline: none;
                border-color: var(--brand-2);
                box-shadow: 0 0 0 4px var(--ring)
            }

        button {
            background: var(--brand);
            color: #fff;
            font-weight: 700;
            border: none;
            letter-spacing: .2px
        }

            button:hover {
                filter: brightness(1.05)
            }

            button:active {
                transform: translateY(1px)
            }

            button:disabled {
                opacity: .55;
                cursor: not-allowed
            }

        .btn-secondary {
            background: #111827
        }

        /* ====== BOTTONE KICK (solo host in lobby) ====== */
        .kickBtn {
            margin-left: 8px;
            padding: 4px 8px;
            border: none;
            border-radius: 8px;
            background: #ef4444;
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

            .kickBtn:hover {
                filter: brightness(1.05)
            }

        /* ============================== LAYOUT ============================== */
        .app-shell {
            width: 100%;
            min-height: 100svh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            overflow-x: clip;
            /* (prima qui avevamo il padding laterale) */
        }

        .brandbar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px 16px 8px;
            user-select: none
        }

        .brand-mark {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            background: linear-gradient(135deg,var(--brand),var(--brand-2));
            color: #fff;
            font-size: 22px;
            box-shadow: 0 10px 20px rgba(139,0,0,.15)
        }

        .brand-title {
            font-weight: 800;
            font-size: clamp(20px,5vw,28px);
            letter-spacing: .5px
        }

        .brand-sub {
            color: var(--muted);
            font-size: 14px;
            margin-top: -2px;
            text-align: center
        }

        .net-banner {
            display: none;
            position: sticky;
            top: 0;
            z-index: 100;
            background: #111827;
            color: #fff;
            text-align: center;
            padding: 6px 10px;
            font-size: 14px
        }

            .net-banner.show {
                display: block
            }

        .screen {
            display: none
        }

            .screen.active {
                display: block
            }

        /* =============================== LOGIN =============================== */
        /* Nascosta di default: la mostriamo solo quando √® .active */
        #screenAccess {
            /* niente display qui: evita di battere .screen { display:none } */
            place-items: center;
            padding: 16px;
        }

            /* Quando √® attiva, il login usa la griglia */
            #screenAccess.active {
                display: grid;
            }

        /* (Extra safety) qualunque .screen con [hidden] √® sempre nascosta */
        .screen[hidden] {
            display: none !important;
        }


        .login-card {
            width: min(520px,92vw);
            border-radius: 20px;
            background: var(--card);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,.6);
            box-shadow: 0 20px 40px rgba(0,0,0,.12);
            padding: 22px;
            animation: floatIn .6s ease both;
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(6px) scale(.98)
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        .login-hero {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px
        }

        .login-hero-emoji {
            font-size: 32px
        }

        .login-hero h2 {
            font-size: 20px;
            font-weight: 700
        }

        .login-hero p {
            margin: 2px 0 0;
            color: var(--muted);
            font-size: 14px
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 10px;
            margin-top: 12px
        }

            .field-row input {
                height: 46px
            }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px
        }

        .helper {
            margin-top: 10px;
            font-size: 12.5px;
            color: var(--muted)
        }

        .login-card:focus-within {
            box-shadow: 0 24px 40px rgba(139,0,0,.18)
        }

        /* =============================== PANELS ============================== */
        /* === FIX login: padding solo su Lobby/Game === */
        /* Aggiungo i "gutter" laterali SOLO a lobby/gioco, NON al login */
        #screenLobby, #screenGame, #screenGamePlayer {
            padding-left: max(8px,var(--sa-balanced));
            padding-right: max(8px,var(--sa-balanced));
        }

        .panel {
            /* pi√π affidabile di 95vw con safe-area */
            max-width: 1000px;
            width: 100%;
            margin: 12px auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,.06);
            padding: 14px;
        }

        /* Invito (lobby) */
        #inviteBox {
            margin-top: 8px;
            padding: 10px;
            border: 1px dashed #f59e0b;
            background: #fff7ed;
            border-radius: 12px;
            display: none
        }

        #inviteLink {
            width: 100%;
            font-weight: 600;
            color: #064420;
            border: 1px dashed #a3e635
        }

        /* Lista giocatori (lobby) */
        #playerList {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .playerCard {
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,.06)
        }

        .online {
            background: #dcfce7;
            color: #065f46
        }

        .offline {
            background: #fee2e2;
            color: #7f1d1d
        }

        /* Log */
        #log, #gameLog, #gameLogPlayer {
            list-style: none;
            margin: 0;
            padding: 10px;
            max-height: 180px;
            overflow: auto;
            border: 1px dashed var(--border);
            background: #fffdf7;
            border-radius: 12px;
        }

        /* ====================== RUOLI (picker host in lobby) ====================== */
        .rolesBox {
            display: grid;
            gap: 8px
        }

        .number-control {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            align-items: center;
            gap: 8px
        }

            .number-control label {
                font-weight: 700
            }

        .count {
            display: inline-grid;
            place-items: center;
            width: 46px;
            height: 42px;
            font-weight: 800;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: #fff
        }

        .inc-btn, .dec-btn {
            display: inline-grid;
            place-items: center;
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: #f4f4f5;
            border: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
            font-size: 18px
        }

        /* ===================== TABELLA HOST (gioco in corso) ===================== */
        #playersTable {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            table-layout: fixed
        }

            #playersTable th, #playersTable td {
                border-bottom: 1px solid var(--border);
                padding: 8px;
                font-size: 15px;
                text-align: center;
                word-break: break-word
            }

            #playersTable th {
                background: #fafafa;
                position: sticky;
                top: 0;
                z-index: 1
            }

            #playersTable tr.row-leader td {
                background: var(--lead);
                box-shadow: inset 4px 0 0 var(--lead-accent)
            }

            #playersTable tr.row-tied td {
                background: var(--tie);
                box-shadow: inset 4px 0 0 var(--tie-accent)
            }

        /* ============================= GRIGLIA PLAYER ============================= */
        .playersGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
            gap: 8px
        }

        .playersGridItem {
            padding: 14px 16px;
            border-radius: 14px;
            color: #fff;
            text-align: center;
            min-height: 64px;
            display: grid;
            place-items: center;
            position: relative;
            box-shadow: 0 8px 16px rgba(0,0,0,.12);
            font-size: 15px;
        }

        .voters {
            font-size: 12px;
            margin-top: 6px;
            color: #fff;
            background: rgba(0,0,0,.25);
            border-radius: 10px;
            padding: 4px 6px
        }

        /* =============================== ROLE MODAL =============================== */
        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            backdrop-filter: blur(2px);
            z-index: 40
        }

        #roleCard {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            background: #fff;
            padding: 22px;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,0,0,.25);
            text-align: center;
            z-index: 50;
            width: min(92vw,440px)
        }

            #roleCard h2 {
                font-size: 22px
            }

        #closeRoleCard {
            margin-top: 14px
        }

        /* =============================== ROLES GUIDE ============================== */
        .rolesGuideGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
            gap: 12px;
            margin-top: 8px
        }

        .roleCardMini {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 8px 16px rgba(0,0,0,.08);
            display: flex;
            flex-direction: column;
            gap: 6px
        }

            .roleCardMini .title {
                font-weight: 800;
                display: flex;
                align-items: center;
                gap: 8px
            }

            .roleCardMini .badge {
                font-size: 24px;
                line-height: 1
            }

            .roleCardMini .desc {
                font-size: 14px;
                color: var(--muted)
            }

        /* ========================== CONTATORE GIOCATORI ========================== */
        .countWrap {
            display: inline-flex;
            gap: 8px;
            align-items: baseline;
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 800
        }

            .countWrap .muted {
                color: var(--muted);
                font-weight: 600
            }

        /* ======================= HOST + ID NELLA STESSA RIGA ====================== */
        .hostRow {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: baseline;
            margin: 6px 0
        }

            .hostRow code {
                background: #f8fafc;
                border: 1px solid var(--border);
                border-radius: 6px;
                padding: 2px 6px;
                font-family: ui-monospace,SFMono-Regular,Menlo,monospace;
                overflow-wrap: anywhere;
            }

        /* ============================== MEDIA QUERIES ============================= */
        @media (max-width:600px) {
            /* background centrato meglio sui telefoni */
            body {
                background: radial-gradient(1200px 800px at 50% -10%, #ffd0c2 0%, transparent 55%), radial-gradient(1000px 700px at 50% 110%, #ffe9b0 0%, transparent 55%), linear-gradient(135deg,#fff7f3 0%,#ffe9e3 35%,#fff6e6 100%);
            }
        }

        @media (max-width:560px) {
            .brandbar {
                padding-top: 14px
            }

            .brand-sub {
                font-size: 13px
            }

            .field-row {
                grid-template-columns: 1fr
            }

            .btn-row {
                grid-template-columns: 1fr
            }

            .login-card {
                padding: 18px
            }
        }

        /* ‚úÖ Lobby nascosta di default */
        #screenLobby {
            display: none;
        }

            /* ‚úÖ Lobby visibile SOLO quando ha .active */
            #screenLobby.active {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }


            #screenLobby .panel {
                margin: 0 auto
            }
        /* gap gestisce lo spazio verticale */
    </style>
</head>

<body>
    <div class="app-shell">
        <!-- Top brand -->
        <header class="brandbar" aria-label="Intestazione">
            <div class="brand-mark" aria-hidden="true">üê∫</div>
            <div>
                <div class="brand-title">Lupus in Fabula</div>
                <div class="brand-sub">Gioca con gli amici, ovunque.</div>
            </div>
        </header>
        <div id="netBanner" class="net-banner" role="status" aria-live="polite">Riconnessione in corso‚Ä¶</div>

        <!-- ACCESSO -->
        <main id="screenAccess" class="screen active" aria-labelledby="accessoTitolo">
            <section class="login-card" role="group" aria-describedby="accessoHelp">
                <div class="login-hero">
                    <div class="login-hero-emoji" aria-hidden="true">üé≤</div>
                    <div>
                        <h2 id="accessoTitolo">Accesso</h2>
                        <p id="accessoHelp">Entra con il tuo nome e l'ID della stanza. Benvenut…ô al villaggio!</p>
                    </div>
                </div>

                <div class="field-row">
                    <input id="name" placeholder="Il tuo nome" aria-label="Nome" />
                    <input id="roomIdInput" placeholder="ID stanza" aria-label="ID Stanza" />
                </div>

                <div class="btn-row">
                    <button id="createBtn" onclick="createRoom()" disabled>üé™ Crea stanza</button>
                    <button id="joinBtn" onclick="joinRoom()" disabled>‚û°Ô∏è Unisciti</button>
                </div>

                <div class="helper">I pulsanti si attivano quando sei connesso al server.</div>
            </section>
        </main>

        <!-- LOBBY -->
        <section id="screenLobby" class="screen" aria-labelledby="lobbyTitolo">
            <div class="panel">
                <h2 id="lobbyTitolo">Lobby</h2>
                <p class="hostRow">
                    üëë Host: <span id="hostNameText"></span>
                    &nbsp;‚Ä¢&nbsp;
                    üè∑Ô∏è ID: <code id="currentRoomIdText"></code>
                </p>

                <div id="inviteBox">
                    <p>Invita altri giocatori con questo link:</p>
                    <input id="inviteLink" type="text" readonly />
                    <div class="btn-row" style="margin-top:8px;">
                        <button onclick="copyInvite()">üìã Copia link</button>
                        <button class="btn-secondary" onclick="shareInvite()">üì§ Condividi</button>
                    </div>
                </div>

                <div class="btn-row" style="margin-top:8px;">
                    <button class="btn-secondary" onclick="exitToLogin()">‚èèÔ∏è Esci</button>
                </div>
            </div>

            <div class="panel">
                <h3>üë• Giocatori connessi</h3>
                <div id="playerList"></div>
            </div>

            <!-- SOLO HOST: selezione ruoli in un pannello dedicato -->
            <div id="hostControls" class="panel" style="display:none;">
                <div class="countWrap" style="margin-bottom:10px;">
                    üë• In stanza: <span id="playerCount">0</span>
                    <span class="muted" id="playerCountOnline"></span>
                </div>

                <h3>‚öîÔ∏è Imposta ruoli e avvia</h3>
                <div class="rolesBox">
                    <div class="number-control" data-role="wolves"><label>üê∫ Lupi</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="villagers"><label>üåæ Contadini</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="guards"><label>üíã Puttane</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="seers"><label>üîÆ Veggenti</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="scemo"><label>ü¶ß Scemo</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="hunter"><label>üèπ Cacciatore</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="witch"><label>üß™ Strega</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="lara"><label>üåô Lara</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="mayor"><label>üéñÔ∏è Sindaco</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                    <div class="number-control" data-role="hitman"><label>üî´ Sicario</label><span class="dec-btn">‚ûñ</span><span class="count">0</span><span class="inc-btn">‚ûï</span></div>
                </div>

                <div class="btn-row" style="margin-top:10px;">
                    <button onclick="startGame()">üöÄ Avvia partita</button>
                </div>
            </div>

            <!-- Ruoli: pannello separato -->
            <div class="panel" id="rolesPanelHost">
                <h3>üìò Ruoli del gioco</h3>
                <div id="rolesGuideHost" class="rolesGuideGrid"></div>
            </div>

            <!-- Log: pannello separato -->
            <div class="panel" id="logPanelLobby">
                <h3>üìú Log eventi</h3>
                <ul id="log"></ul>
            </div>
        </section>

        <!-- GIOCO HOST -->
        <section id="screenGame" class="screen" aria-labelledby="giocoHostTitolo">
            <div class="panel">
                <h2 id="giocoHostTitolo">üé≤ Partita in corso</h2>
                <p>üëë Host: <span id="hostNameInGame"></span> &nbsp;‚Ä¢&nbsp; üè∑Ô∏è ID: <code id="roomIdInGame"></code></p>

                <h3>üë• Giocatori e ruoli</h3>
                <table id="playersTable" border="0"></table>

                <div class="btn-row" style="margin-top:10px;">
                    <button id="votingBtn" onclick="toggleVoting()">Votazione</button>
                    <button id="restartBtn" class="btn-secondary" onclick="restartGame()">üîÑ Restart</button>
                    <button class="btn-secondary" onclick="exitToLogin()">‚èèÔ∏è Esci</button>
                </div>

                <h3 style="margin-top:14px;">üìú Log eventi</h3>
                <ul id="gameLog"></ul>
            </div>
        </section>

        <!-- GIOCO GIOCATORI -->
        <section id="screenGamePlayer" class="screen" aria-labelledby="giocoPlayerTitolo">
            <div class="panel">
                <h2 id="giocoPlayerTitolo">üé≤ Partita in corso</h2>
                <p>üëë Host: <span id="hostNamePlayer"></span></p>

                <h3>üë• Giocatori</h3>
                <div id="playersGrid" class="playersGrid"></div>

                <button id="showRoleBtn" style="display:none; margin-top:10px;">Mostra ruolo</button>

                <h3 style="margin-top:14px;">üìò Ruoli del gioco</h3>
                <div id="rolesGuidePlayer" class="rolesGuideGrid"></div>

                <div class="btn-row" style="margin-top:8px;">
                    <button class="btn-secondary" onclick="exitToLogin()">‚èèÔ∏è Esci</button>
                </div>

                <h3 style="margin-top:14px;">üìú Log eventi</h3>
                <ul id="gameLogPlayer"></ul>
            </div>
        </section>

        <!-- Overlay + Role Card -->
        <div id="overlay"></div>
        <div id="roleCard" role="dialog" aria-modal="true" aria-labelledby="roleTitle">
            <h2 id="roleTitle">üÉè Il tuo ruolo</h2>
            <p id="roleText">Nessun ruolo</p>
            <p id="roleDescription" style="margin-top:10px; font-style:italic; color:#555;">Descrizione</p>
            <button id="closeRoleCard">Chiudi</button>
        </div>

        <footer style="text-align:center; padding: 12px; color: var(--muted); font-size: 12.5px;">
            ¬© Villaggio di Lupus ‚Äî divertiti responsabilmente üê∫
        </footer>
    </div>

    <script>
        /* ====================== SignalR: setup ====================== */
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/gamehub")
            .withAutomaticReconnect([0, 1000, 5000, 10000, 20000, 30000])
            .build();
        connection.serverTimeoutInMilliseconds = 120000;
        connection.keepAliveIntervalInMilliseconds = 15000;

        /* ====================== Stato globale ====================== */
        let currentRoomId = null, isHost = false, myRole = null, votingOpen = false, myVote = null, currentPlayers = [], gameStarted = false;

        /* Alias nomi rapidi */
        const NAME_MAP = { "nico": "N1k0GgAY", "niko": "N1k0GgAY", "nicolo": "N1k0gAY", "gioia": "TriS5tezZa", "carly": "Carmine", "carlotta": "Carmine", "carli": "Carmine", "benni": "Benagol", "benny": "Benagol", "matte": "MaTTe0R0Li", "matteo": "MaTTe0R0Li" };
        const normalizeName = s => (s || "").trim().toLowerCase();
        const applyNameMapping = s => NAME_MAP[normalizeName(s || "")] || (s || "").trim();

        /* Ruoli (nome + descrizione) */
        const roleNames = { wolf: "üê∫ Lupo", villager: "üë®‚Äçüåæ Contadino", seer: "üîÆ Veggente", guard: "üíã Puttana", scemo: "ü¶ß Scemo", hunter: "üèπ Cacciatore", witch: "üß™ Strega", lara: "üåô Lara", mayor: "üéñÔ∏è Sindaco", hitman: "üî´ Sicario" };
        const roleDescriptions = {
            wolf: `Di notte scegliete insieme una vittima.
Vincete se i lupi eliminano tutti gli altri.`,
            villager: `Non hai poteri speciali.
Usa l'astuzia per smascherare i lupi.`,
            seer: `Ogni notte puoi scoprire se un giocatore √® lupo.`,
            guard: `Ogni notte puoi proteggere un giocatore o te stessa
dall'attacco dei lupi.`,
            scemo: `Vinci se vieni eliminato dai voti del villaggio.`,
            hunter: `Se vieni eliminato, puoi scegliere immediatamente
un altro giocatore da portare con te.`,
            witch: `Hai due pozioni: una per salvare una vittima, una per uccidere.
Puoi usarle solo una volta ciascuna.`,
            lara: `All'inizio sei una cittadina.
Se vieni uccisa dai lupi, diventi un Lupo.
Vinci con i cittadini finch√© sei cittadina,
ma se diventi Lupo vinci con i lupi.`,
            mayor: `Durante le votazioni il tuo voto conta doppio.`,
            hitman: `Hai una pistola con un solo colpo.
Puoi usarla una volta in tutta la partita per eliminare un giocatore.`
        };

        /* ====================== Riferimenti DOM + modale ruolo ====================== */
        const overlay = document.getElementById("overlay");
        const roleCard = document.getElementById("roleCard");
        const closeRoleBtn = document.getElementById("closeRoleCard");
        const roleText = document.getElementById("roleText");
        const roleDescEl = document.getElementById("roleDescription");
        const netBanner = document.getElementById('netBanner');

        function openRoleCard() { overlay.style.display = "block"; roleCard.style.display = "block"; }
        function closeRoleCardFn() { overlay.style.display = "none"; roleCard.style.display = "none"; }
        document.getElementById("showRoleBtn").onclick = () => {
            if (myRole) { roleText.textContent = roleNames[myRole] || myRole; roleDescEl.textContent = roleDescriptions[myRole] || "Nessuna descrizione."; openRoleCard(); }
            else alert("‚ùå Nessun ruolo assegnato ancora.");
        };
        closeRoleBtn.onclick = closeRoleCardFn; overlay.onclick = closeRoleCardFn;
        window.addEventListener("keydown", e => { if (e.key === "Escape") closeRoleCardFn(); });

        /* ====================== Connessione ====================== */
        async function startConn() {
            try {
                if (connection.state !== signalR.HubConnectionState.Connected) {
                    await connection.start(); logLobby("‚úÖ Connesso al server");
                }
            } catch (err) {
                console.error(err); logLobby("‚ùå Connessione fallita, riprovo..."); setTimeout(startConn, 2000);
            } finally { updateConnectionUI(); }
        }
        startConn();

        function updateConnectionUI() {
            const connected = connection.state === signalR.HubConnectionState.Connected;
            netBanner?.classList.toggle('show', !connected);
            const c = document.getElementById('createBtn'), j = document.getElementById('joinBtn');
            if (c) c.disabled = !connected; if (j) j.disabled = !connected;
        }
        connection.onreconnecting(updateConnectionUI);
        connection.onclose(() => { updateConnectionUI(); setTimeout(startConn, 1000); });

        /* Heartbeat */
        let hbTimer = null;
        function startHeartbeat() { if (hbTimer) return; hbTimer = setInterval(() => { if (connection.state === signalR.HubConnectionState.Connected) connection.invoke("Heartbeat").catch(() => { }); }, 20000); }
        function stopHeartbeat() { if (hbTimer) { clearInterval(hbTimer); hbTimer = null; } }

        function showScreen(id) {
            const screens = document.querySelectorAll(".screen");
            screens.forEach(s => {
                s.classList.remove("active");
                s.setAttribute("aria-hidden", "true");
                s.hidden = true;
                if ("inert" in s) s.inert = true; // opzionale: blocca interazioni
            });

            const target = document.getElementById(id);
            if (target) {
                target.classList.add("active");
                target.removeAttribute("aria-hidden");
                target.hidden = false;
                if ("inert" in target) target.inert = false;
            }

            if (id === "screenAccess") stopHeartbeat(); else startHeartbeat();
        }
        function logLobby(msg) {
            const logEl = document.getElementById("log"); if (!logEl) return;
            const li = document.createElement("li"); li.textContent = msg; logEl.appendChild(li);
            if (logEl.children.length > 80) logEl.removeChild(logEl.firstChild);
        }
        function logGame(msg) {
            const logEl = isHost ? document.getElementById("gameLog") : document.getElementById("gameLogPlayer"); if (!logEl) return;
            const li = document.createElement("li"); li.textContent = msg; logEl.appendChild(li);
            if (logEl.children.length > 80) logEl.removeChild(logEl.firstChild);
        }

        /* ====================== Helpers UI ====================== */
        function setRoomLabels() {
            const rid = currentRoomId || "";
            const ridHost = document.getElementById("roomIdInGame");
            const ridLobby = document.getElementById("currentRoomIdText");
            if (ridLobby) ridLobby.textContent = rid;
            if (ridHost) ridHost.textContent = rid;
        }
        function updateLobbyCounters(players) {
            const total = players.length, online = players.filter(p => p.isOnline).length;
            const totalEl = document.getElementById("playerCount");
            const onlineEl = document.getElementById("playerCountOnline");
            if (totalEl) totalEl.textContent = total;
            if (onlineEl) onlineEl.textContent = `(online: ${online})`;
        }
        function renderRolesGuide(containerId) {
            const el = document.getElementById(containerId); if (!el) return;
            el.innerHTML = "";
            const order = ["wolf", "villager", "seer", "guard", "scemo", "hunter", "witch", "lara", "mayor", "hitman"];
            order.forEach(k => {
                const card = document.createElement("div"); card.className = "roleCardMini";
                const title = document.createElement("div"); title.className = "title";
                const badge = document.createElement("span"); badge.className = "badge";
                const rn = roleNames[k] || k; const maybeEmoji = rn.split(" ")[0];
                badge.textContent = /\p{Extended_Pictographic}/u.test(maybeEmoji) ? maybeEmoji : "üÉè";
                const text = document.createElement("span"); text.textContent = rn;
                const desc = document.createElement("div"); desc.className = "desc"; desc.textContent = roleDescriptions[k] || "";
                title.appendChild(badge); title.appendChild(text); card.appendChild(title); card.appendChild(desc); el.appendChild(card);
            });
        }

        /* ====================== Eventi dal server ====================== */
        connection.on("UpdateLobby", (players, hostName) => {
            updateConnectionUI();

            (document.getElementById("hostNameText") || {}).textContent = hostName || "Sconosciuto";
            (document.getElementById("hostNameInGame") || {}).textContent = hostName || "Sconosciuto";
            (document.getElementById("hostNamePlayer") || {}).textContent = hostName || "Sconosciuto";

            const list = document.getElementById("playerList");
            if (list) {
                list.innerHTML = "";
                players.forEach(p => {
                    const d = document.createElement("div");
                    d.classList.add("playerCard", p.isOnline ? "online" : "offline");
                    const nameSpan = document.createElement("span");
                    nameSpan.textContent = `${p.name} ${p.isOnline ? "" : "(offline)"}`;
                    d.appendChild(nameSpan);

                    if (isHost && !gameStarted) {
                        const btn = document.createElement("button");
                        btn.className = "kickBtn"; btn.title = `Espelli ${p.name}`; btn.textContent = "‚úñ";
                        btn.onclick = () => kickPlayer(p.name);
                        d.appendChild(btn);
                    }
                    list.appendChild(d);
                });
            }

            updateLobbyCounters(players);

            // guida ruoli: host vs non-host (se vuoi anche per non-host, aggiungi un pannello con id="rolesGuideLobby")
            renderRolesGuide("rolesGuideHost");

            if (!gameStarted) showScreen("screenLobby");
            refreshInviteUI(currentRoomId);
            setRoomLabels();
        });

        connection.on("JoinError", msg => alert(msg));

        connection.on("ReceiveRole", role => {
            myRole = role;
            const btn = document.getElementById("showRoleBtn"); if (btn) btn.style.display = "inline-block";
        });

        connection.on("GameStarted", (players) => {
            gameStarted = true; currentPlayers = players || [];
            if (!isHost) {
                const grid = document.getElementById("playersGrid");
                const gl = document.getElementById("gameLogPlayer");
                if (grid) grid.innerHTML = "";
                if (gl) gl.innerHTML = "";
            }
            if (isHost) { showScreen("screenGame"); renderHostTable(currentPlayers); }
            else { showScreen("screenGamePlayer"); renderPlayers(currentPlayers); renderRolesGuide("rolesGuidePlayer"); }
            refreshInviteUI(currentRoomId); setRoomLabels();
        });

        connection.on("VotingStarted", () => {
            votingOpen = true; logGame("üó≥Ô∏è Votazioni aperte!");
            renderPlayers(currentPlayers);
            if (isHost) {
                const btn = document.getElementById("votingBtn");
                if (btn) { btn.style.backgroundColor = "#4A90E2"; btn.textContent = "Il dado √® tratto"; }
            }
        });

        connection.on("VotingEnded", () => {
            votingOpen = false; logGame("üõë Votazioni chiuse!");
            renderPlayers(currentPlayers);
            if (isHost) {
                const btn = document.getElementById("votingBtn");
                if (btn) { btn.style.backgroundColor = "var(--brand)"; btn.textContent = "Votazione"; }
            }
        });

        connection.on("UpdateVotes", (players) => { currentPlayers = players || []; renderPlayers(currentPlayers); if (isHost) renderHostTable(currentPlayers); });

        connection.on("JoinedAsHost", (players) => { isHost = true; currentPlayers = players || []; showScreen("screenGame"); renderHostTable(currentPlayers); refreshInviteUI(currentRoomId); });

        connection.on("PlayerEliminated", (playerName) => {
            const player = currentPlayers.find(p => p.name === playerName); if (player) player.eliminated = true;
            renderHostTable(currentPlayers); renderPlayers(currentPlayers); logGame(`‚ö∞Ô∏è ${playerName} √® stato eliminato!`);
        });

        connection.on("GameRestarted", (players, hostName) => {
            gameStarted = false; votingOpen = false; myVote = null; myRole = null; currentPlayers = players || [];
            overlay.style.display = "none"; roleCard.style.display = "none";
            const roleBtn = document.getElementById("showRoleBtn"); if (roleBtn) roleBtn.style.display = "none";

            (document.getElementById("hostNameText") || {}).textContent = hostName || "Sconosciuto";
            (document.getElementById("hostNameInGame") || {}).textContent = hostName || "Sconosciuto";
            (document.getElementById("hostNamePlayer") || {}).textContent = hostName || "Sconosciuto";
            (document.getElementById("currentRoomIdText") || {}).textContent = currentRoomId || "";

            const list = document.getElementById("playerList");
            if (list) {
                list.innerHTML = "";
                (players || []).forEach(p => {
                    const d = document.createElement("div");
                    d.classList.add("playerCard", p.isOnline ? "online" : "offline");
                    d.textContent = `${p.name} ${p.isOnline ? "" : "(offline)"}`;
                    list.appendChild(d);
                });
            }

            (document.getElementById("playersGrid") || {}).innerHTML = "";
            (document.getElementById("gameLog") || {}).innerHTML = "";
            (document.getElementById("gameLogPlayer") || {}).innerHTML = "";
            (document.getElementById("playersTable") || {}).innerHTML = "";

            updateLobbyCounters(players || []);
            showScreen("screenLobby");
            const hostCtrls = document.getElementById("hostControls");
            if (isHost && hostCtrls) hostCtrls.style.display = "block";
            const btn = document.getElementById("votingBtn");
            if (btn) { btn.style.backgroundColor = "var(--brand)"; btn.textContent = "Votazione"; btn.title = "Apri votazioni"; }

            logLobby("üîÑ La partita √® stata riavviata, siete tornati in lobby.");
            refreshInviteUI(currentRoomId); renderRolesGuide("rolesGuideHost"); setRoomLabels();
        });

        connection.on("ReceiveHostKey", (hostKey) => { localStorage.setItem("lupus_hostKey", hostKey); });

        /* ====================== Render Host Table (highlight leader/tie) ====================== */
        function renderHostTable(players) {
            const tbody = document.querySelector("#playersTable"); if (!tbody) return;
            tbody.innerHTML = "";
            const header = document.createElement("tr");
            header.innerHTML = "<th>Nome</th><th>Ruolo</th><th>Stato</th><th>Voti</th><th>Azioni</th>";
            tbody.appendChild(header);

            const votes = players.filter(p => !p.eliminated).map(p => p.votes || 0);
            const maxVotes = votes.length ? Math.max(...votes) : 0;
            const leaders = players.filter(p => !p.eliminated && (p.votes || 0) === maxVotes);
            const isTie = (maxVotes > 0 && leaders.length > 1);

            players.forEach(p => {
                const tr = document.createElement("tr");
                if (maxVotes > 0 && !p.eliminated && (p.votes || 0) === maxVotes) {
                    tr.className = isTie ? "row-tied" : "row-leader";
                }
                const nameDisplay = p.eliminated ? `‚ò†Ô∏è ${p.name}` : p.name;
                const nameStyle = p.eliminated ? "color:gray;text-decoration:line-through;" : "";
                const roleDisplay = p.role ? (roleNames[p.role] || p.role) : "";
                tr.innerHTML = `
              <td style="${nameStyle}">${nameDisplay}</td>
              <td>${roleDisplay}</td>
              <td style="color:${p.isOnline ? 'green' : 'red'}">${p.isOnline ? 'Online' : 'Offline'}</td>
              <td>${p.votes || 0}</td>
              <td>${!p.eliminated ? `<button onclick="eliminatePlayer('${p.name}')">Elimina</button>` : ""}</td>
            `;
                tbody.appendChild(tr);
            });
        }

        /* ====================== Render griglia giocatori (client) ====================== */
        function renderPlayers(players) {
            const container = document.getElementById("playersGrid"); if (!container) return;
            container.innerHTML = "";
            players.forEach(p => {
                const card = document.createElement("div"); card.className = "playersGridItem";
                let displayName = p.eliminated ? `‚ò†Ô∏è ${p.name}` : p.name;
                if (p.role === "mayor") displayName += " üéñÔ∏è";
                const baseText = (!p.eliminated && p.votes > 0) ? `${displayName} (${p.votes})` : displayName;
                card.textContent = baseText;
                card.style.backgroundColor = p.eliminated ? "#9ca3af" : (votingOpen ? (myVote === p.name ? "#f59e0b" : "#4A90E2") : "#6b7280");
                card.style.cursor = (votingOpen && !p.eliminated) ? "pointer" : "default";
                card.style.opacity = p.isOnline ? "1" : ".7";

                if (votingOpen && Array.isArray(p.votedBy) && p.votedBy.length > 0) {
                    const votersList = document.createElement("div"); votersList.className = "voters";
                    const title = document.createElement("div"); title.textContent = "Votato da:"; votersList.appendChild(title);
                    const ul = document.createElement("ul"); ul.style.margin = "4px 0 0"; ul.style.padding = "0"; ul.style.listStyle = "none";
                    p.votedBy.forEach(name => { const li = document.createElement("li"); li.textContent = name; ul.appendChild(li); });
                    votersList.appendChild(ul); card.appendChild(votersList);
                }

                if (votingOpen && !p.eliminated) {
                    card.onclick = async () => { myVote = p.name; renderPlayers(currentPlayers); try { await connection.invoke("VotePlayer", currentRoomId, p.name); } catch (e) { console.error(e); } };
                }
                container.appendChild(card);
            });
        }

        /* ====================== Azioni base ====================== */
        function readRoleCounts() {
            const counts = {};
            document.querySelectorAll(".rolesBox .number-control").forEach(ctrl => {
                const key = ctrl.dataset.role;
                const val = parseInt(ctrl.querySelector(".count").textContent) || 0;
                counts[key] = val;
            });
            return counts;
        }

        function createRoom() {
            const rawName = document.getElementById("name").value || "Host";
            const name = applyNameMapping(rawName);
            isHost = true;

            connection.invoke("CreateRoom", name).then(id => {
                currentRoomId = id;
                localStorage.setItem("lupus_roomId", id);
                localStorage.setItem("lupus_name", name);
                localStorage.setItem("lupus_autoJoin", "true");

                (document.getElementById("hostNameText") || {}).textContent = name;
                setRoomLabels();
                logLobby(`üé™ Stanza creata: ${currentRoomId}`);

                showScreen("screenLobby");
                const hc = document.getElementById("hostControls"); if (hc) hc.style.display = "block";
                renderRolesGuide("rolesGuideHost");
                refreshInviteUI(currentRoomId);
            }).catch(err => {
                console.error(err);
                logLobby("‚ùå Errore nella creazione della stanza");
            });
        }

        async function joinRoom() {
            const rawName = document.getElementById("name").value || "Giocatore";
            const name = applyNameMapping(rawName);
            const roomId = document.getElementById("roomIdInput").value?.trim();
            if (!roomId) { alert("Inserisci l'ID stanza"); return; }

            if (connection.state !== signalR.HubConnectionState.Connected) {
                try { await startConn(); } catch { }
                if (connection.state !== signalR.HubConnectionState.Connected) { logLobby("‚ùå Non connesso al server."); return; }
            }

            currentRoomId = roomId; myRole = null; votingOpen = false; myVote = null;

            const savedHostName = (localStorage.getItem("lupus_name") || "").trim().toLowerCase();
            const hostKey = localStorage.getItem("lupus_hostKey") || null;
            const isHostName = name.trim().toLowerCase() === savedHostName;
            const hostKeyToSend = isHostName ? hostKey : null;

            try {
                const result = await connection.invoke("JoinRoom", roomId, name, hostKeyToSend);
                if (result && result.ok === false) { alert(result.error || "Impossibile entrare nella stanza."); return; }

                isHost = !!result.isHost; myRole = result.role || null; currentPlayers = result.players || [];
                votingOpen = !!result.votingOpen; gameStarted = !!result.gameStarted;

                localStorage.setItem("lupus_roomId", currentRoomId);
                localStorage.setItem("lupus_name", name);
                localStorage.setItem("lupus_autoJoin", "true");

                if (isHost) {
                    if (gameStarted) { showScreen("screenGame"); renderHostTable(currentPlayers); }
                    else { showScreen("screenLobby"); const hostCtrls = document.getElementById("hostControls"); if (hostCtrls) hostCtrls.style.display = "block"; }
                    const btn = document.getElementById("votingBtn");
                    if (btn) {
                        if (votingOpen) { btn.style.backgroundColor = "#4A90E2"; btn.textContent = "Il dado √® tratto"; }
                        else { btn.style.backgroundColor = "var(--brand)"; btn.textContent = "Votazione"; }
                    }
                } else if (gameStarted) {
                    showScreen("screenGamePlayer"); renderPlayers(currentPlayers);
                } else {
                    showScreen("screenLobby");
                }

                if (myRole) { const roleBtn = document.getElementById("showRoleBtn"); if (roleBtn) roleBtn.style.display = "inline-block"; }

                updateLobbyCounters(result.players || []);
                setRoomLabels(); refreshInviteUI(currentRoomId); updateConnectionUI();
            } catch (err) {
                console.error(err); logLobby("‚ùå Errore durante il join");
            }
        }

        async function startGame() {
            if (!isHost) { alert("‚ùå Solo l'host pu√≤ avviare la partita!"); return; }
            const r = readRoleCounts();
            const totalRoles = Object.values(r).reduce((a, b) => a + b, 0);
            if (totalRoles < currentPlayers.length) { alert("‚ùå Ruoli insufficienti!"); return; }

            try {
                await connection.invoke("StartGame", currentRoomId, r.wolves, r.villagers, r.seers, r.guards, r.scemo, r.hunter, r.witch, r.lara, r.mayor, r.hitman);
                logLobby("üöÄ Partita avviata!");
            } catch (err) {
                console.error(err); logLobby("‚ùå Errore nell'avvio della partita");
            }
        }

        async function restartGame() {
            if (!isHost) return;
            if (!confirm("Vuoi davvero riavviare la partita e tornare in lobby?")) return;
            try { await connection.invoke("RestartGame", currentRoomId); }
            catch (err) { console.error(err); alert("Errore durante il riavvio della partita"); }
        }

        function toggleVoting() {
            if (!isHost) return;
            if (!votingOpen) connection.invoke("OpenVoting", currentRoomId).catch(console.error);
            else connection.invoke("CloseVoting", currentRoomId).catch(console.error);
        }

        async function eliminatePlayer(playerName) {
            if (!isHost) return;
            if (!confirm(`Sei sicuro di eliminare ${playerName}?`)) return;
            try { await connection.invoke("EliminatePlayer", currentRoomId, playerName); }
            catch (err) { console.error(err); alert("Errore durante l'eliminazione"); }
        }

        // Espulsione (solo host, solo in lobby)
        async function kickPlayer(playerName) {
            if (!isHost || gameStarted) return;
            if (!confirm(`Vuoi espellere ${playerName} dalla stanza?`)) return;
            try {
                await connection.invoke("KickPlayer", currentRoomId, playerName);
                logLobby(`üö´ Hai espulso ${playerName}`);
            } catch (err) {
                console.error(err); alert("Errore durante l'espulsione");
            }
        }
        connection.on("Kicked", () => { alert("Sei stato espulso dalla stanza dall'host."); exitToLogin(); });

        /* ====================== Invite (lobby) ====================== */
        function refreshInviteUI(roomId) {
            const link = roomId ? `${window.location.origin}${window.location.pathname}?roomId=${encodeURIComponent(roomId)}` : '';
            const box = document.getElementById('inviteBox');
            const input = document.getElementById('inviteLink');
            if (roomId) { if (box) box.style.display = 'block'; if (input) input.value = link; }
            else { if (box) box.style.display = 'none'; }
        }
        function copyInvite() {
            const input = document.getElementById('inviteLink'); if (!input) return;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(input.value).then(() => alert('üìã Link copiato!')).catch(() => fallbackCopy(input));
            } else fallbackCopy(input);
        }
        function fallbackCopy(input) {
            const tmp = document.createElement('textarea'); tmp.value = input.value; tmp.style.position = 'absolute'; tmp.style.left = '-9999px';
            document.body.appendChild(tmp); tmp.select();
            try { const ok = document.execCommand('copy'); alert(ok ? 'üìã Link copiato!' : '‚ö†Ô∏è Copia manuale'); }
            catch { alert('‚ö†Ô∏è Copia manuale'); }
            document.body.removeChild(tmp);
        }
        function shareInvite() {
            const input = document.getElementById('inviteLink'); if (!input) return;
            const link = input.value;
            if (navigator.share) navigator.share({ title: 'Invito Lupus in Tabula', text: 'Entra nella mia stanza!', url: link }).catch(() => { });
            else alert('Copia il link manualmente: ' + link);
        }

        /* ====================== Prefill + Auto-join ====================== */
        window.addEventListener("load", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomIdFromLink = urlParams.get("roomId");

            const nameInput = document.getElementById("name");
            const roomInput = document.getElementById("roomIdInput");

            const ridLS = localStorage.getItem("lupus_roomId");
            const nmLS = localStorage.getItem("lupus_name");
            const auto = localStorage.getItem("lupus_autoJoin") === "true";

            if (nmLS) nameInput.value = nmLS;
            if (roomIdFromLink) { roomInput.value = roomIdFromLink; logLobby(`üîó Sei stato invitato alla stanza: ${roomIdFromLink}`); }
            else if (ridLS) { roomInput.value = ridLS; }

            // +/- handlers (host UI)
            document.querySelectorAll(".rolesBox .number-control").forEach(ctrl => {
                const dec = ctrl.querySelector(".dec-btn"), inc = ctrl.querySelector(".inc-btn"), cnt = ctrl.querySelector(".count");
                const get = () => parseInt(cnt.textContent) || 0;
                dec?.addEventListener("click", () => { cnt.textContent = Math.max(0, get() - 1); });
                inc?.addEventListener("click", () => { cnt.textContent = get() + 1; });
            });

            // guida ruoli (se vuoi mostrarla anche ai non-host in lobby aggiungi un container con id="rolesGuideLobby")
            renderRolesGuide("rolesGuideHost");

            const wantAutoJoin = auto && nameInput.value.trim() && roomInput.value.trim();
            const tryJoin = () => {
                if (connection.state !== signalR.HubConnectionState.Connected) { startConn(); setTimeout(tryJoin, 800); return; }
                joinRoom().catch(() => setTimeout(tryJoin, 1500));
            };
            if (wantAutoJoin) tryJoin(); else updateConnectionUI();
        });

        connection.onreconnected(() => {
            updateConnectionUI();
            const rid = localStorage.getItem("lupus_roomId");
            const nm = localStorage.getItem("lupus_name");
            const auto = localStorage.getItem("lupus_autoJoin") === "true";
            if (auto && rid && nm) joinRoom().catch(() => { });
        });

        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) {
                if (connection.state !== signalR.HubConnectionState.Connected) startConn();
                const rid = localStorage.getItem("lupus_roomId");
                const nm = localStorage.getItem("lupus_name");
                const auto = localStorage.getItem("lupus_autoJoin") === "true";
                if (auto && rid && nm) joinRoom().catch(() => { });
            }
        });

        /* ====================== Esci ====================== */
        async function exitToLogin() {
            try { if (currentRoomId) { try { await connection.invoke('LeaveRoom', currentRoomId); } catch { } } } catch { }
            try { await connection.stop(); } catch { }
            localStorage.removeItem('lupus_roomId'); localStorage.removeItem('lupus_hostKey'); localStorage.removeItem('lupus_autoJoin');
            currentRoomId = null; isHost = false; myRole = null; votingOpen = false; myVote = null; currentPlayers = []; gameStarted = false;
            ['log', 'gameLog', 'gameLogPlayer'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; });
            (document.getElementById('playersGrid') || {}).innerHTML = '';
            (document.getElementById('playersTable') || {}).innerHTML = '';
            refreshInviteUI(null); showScreen('screenAccess');
        }
    </script>
</body>
</html>
