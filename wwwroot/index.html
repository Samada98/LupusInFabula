<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#8b0000">
    <title>Lupus in Fabula</title>

    <!-- Font + SignalR (CDN) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js" defer></script>

    <!-- Config + Loader con fallback -->
    <script>
        // URL dell'hub. Se front e back sono sulla stessa origine, lascia "/gamehub".
        // Se sono su domini diversi, imposta l'URL assoluto, es:
        // window.HUB_URL = "https://api.tuodominio.com/gamehub";
        window.HUB_URL = "/gamehub";

        // Assicura che SignalR esista, altrimenti carica la copia locale
        function ensureSignalR(callback) {
            if (window.signalR) return callback();
            var s = document.createElement('script');
            s.src = '/js/signalr.min.js';  // <-- fallback locale (metti il file in wwwroot/js)
            s.defer = true;
            s.onload = callback;
            s.onerror = function () {
                console.error('Impossibile caricare SignalR (CDN e locale).');
                alert('âš ï¸ Errore nel caricare la libreria SignalR.');
            };
            document.head.appendChild(s);
        }

        // Avvia l'app quando SignalR Ã¨ pronto
        function boot() { ensureSignalR(() => window.initApp && window.initApp()); }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
        else boot();
    </script>

    <style>
        :root {
            --brand: #8b0000;
            --brand-2: #b22222;
            --ok: #4a90e2;
            --warn: #f39c12;
            --bg: #fff;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --ring: rgba(139,0,0,.35);
            --card: rgba(255,255,255,.7);
            --lead: #FDE68A;
            --tie: #FEF3C7;
            --lead-accent: #F59E0B;
            --tie-accent: #FBBF24;
            --sa-left: env(safe-area-inset-left,0px);
            --sa-right: env(safe-area-inset-right,0px);
            --sa-balanced: max(env(safe-area-inset-left,0px),env(safe-area-inset-right,0px));
        }

        html, body {
            width: 100%;
            max-width: 100%;
            height: 100%;
            overflow-x: hidden;
            touch-action: pan-y
        }

        img, video, canvas {
            max-width: 100%;
            height: auto
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: "Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            margin: 0;
            color: var(--text);
            background: radial-gradient(1200px 800px at 80% -10%, #ffd0c2 0%, transparent 60%),radial-gradient(1000px 700px at -10% 90%, #ffe9b0 0%, transparent 60%),linear-gradient(135deg,#fff7f3 0%,#ffe9e3 35%,#fff6e6 100%);
            min-height: 100svh;
            display: grid;
            place-items: stretch
        }

        h1, h2, h3 {
            margin: 0 0 8px
        }

        input, button {
            font-family: inherit;
            font-size: 16px;
            border-radius: 12px;
            border: 1.5px solid var(--border);
            padding: 12px 14px;
            transition: box-shadow .2s,transform .04s,background-color .2s,border-color .2s
        }

        input {
            background: #fff
        }

            input:focus {
                outline: none;
                border-color: var(--brand-2);
                box-shadow: 0 0 0 4px var(--ring)
            }

        button {
            background: var(--brand);
            color: #fff;
            font-weight: 700;
            border: none;
            letter-spacing: .2px
        }

            button:hover {
                filter: brightness(1.05)
            }

            button:active {
                transform: translateY(1px)
            }

            button:disabled {
                opacity: .55;
                cursor: not-allowed
            }

        .btn-secondary {
            background: #111827
        }

        .kickBtn {
            margin-left: 8px;
            padding: 4px 8px;
            border: none;
            border-radius: 8px;
            background: #ef4444;
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

            .kickBtn:hover {
                filter: brightness(1.05)
            }

        .app-shell {
            width: 100%;
            min-height: 100svh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            overflow-x: clip
        }

        .brandbar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px 16px 8px;
            user-select: none
        }

        .brand-mark {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            background: linear-gradient(135deg,var(--brand),var(--brand-2));
            color: #fff;
            font-size: 22px;
            box-shadow: 0 10px 20px rgba(139,0,0,.15)
        }

        .brand-title {
            font-weight: 800;
            font-size: clamp(20px,5vw,28px);
            letter-spacing: .5px
        }

        .brand-sub {
            color: var(--muted);
            font-size: 14px;
            margin-top: -2px;
            text-align: center
        }

        .screen {
            display: none
        }

            .screen.active {
                display: block
            }

        #screenAccess {
            place-items: center;
            padding: 16px
        }

            #screenAccess.active {
                display: grid
            }

            #screenAccess:not(.active) {
                display: none !important
            }

        #screenGamePlayer #showRoleBtn {
            display: block;
            margin: 10px auto 0
        }

        #screenGamePlayer .btn-row {
            display: flex;
            justify-content: center;
            gap: 10px
        }

        .screen[hidden] {
            display: none !important
        }

        .login-card {
            width: min(520px,92vw);
            border-radius: 20px;
            background: var(--card);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,.6);
            box-shadow: 0 20px 40px rgba(0,0,0,.12);
            padding: 22px;
            animation: floatIn .6s ease both
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(6px) scale(.98)
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        .login-hero {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px
        }

        .login-hero-emoji {
            font-size: 32px
        }

        .login-hero h2 {
            font-size: 20px;
            font-weight: 700
        }

        .login-hero p {
            margin: 2px 0 0;
            color: var(--muted);
            font-size: 14px
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 10px;
            margin-top: 12px
        }

            .field-row input {
                height: 46px
            }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px
        }

        .helper {
            margin-top: 10px;
            font-size: 12.5px;
            color: var(--muted)
        }

        .login-card:focus-within {
            box-shadow: 0 24px 40px rgba(139,0,0,.18)
        }

        #screenLobby, #screenGame, #screenGamePlayer {
            padding-left: max(8px,var(--sa-balanced));
            padding-right: max(8px,var(--sa-balanced))
        }

        .panel {
            max-width: 1000px;
            width: 100%;
            margin: 12px auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,.06);
            padding: 14px
        }

        #inviteBox {
            margin-top: 8px;
            padding: 10px;
            border: 1px dashed #f59e0b;
            background: #fff7ed;
            border-radius: 12px;
            display: none
        }

        #inviteLink {
            width: 100%;
            font-weight: 600;
            color: #064420;
            border: 1px dashed #a3e635
        }

        #playerList {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .playerCard {
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,.06)
        }

        .online {
            background: #dcfce7;
            color: #065f46
        }

        .offline {
            background: #fee2e2;
            color: #7f1d1d
        }

        #log, #gameLog, #gameLogPlayer {
            list-style: none;
            margin: 0;
            padding: 10px;
            max-height: 180px;
            overflow: auto;
            border: 1px dashed var(--border);
            background: #fffdf7;
            border-radius: 12px
        }

        .rolesBox {
            display: grid;
            gap: 8px
        }

        .number-control {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            align-items: center;
            gap: 8px
        }

            .number-control label {
                font-weight: 700
            }

        .count {
            display: inline-grid;
            place-items: center;
            width: 46px;
            height: 42px;
            font-weight: 800;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: #fff
        }

        .inc-btn, .dec-btn {
            display: inline-grid;
            place-items: center;
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: #f4f4f5;
            border: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
            font-size: 18px
        }

        #playersTable {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            table-layout: fixed
        }

            #playersTable th, #playersTable td {
                border-bottom: 1px solid var(--border);
                padding: 8px;
                font-size: 15px;
                text-align: center;
                word-break: break-word
            }

            #playersTable th {
                background: #fafafa;
                position: sticky;
                top: 0;
                z-index: 1
            }

            #playersTable tr.row-leader td {
                background: var(--lead);
                box-shadow: inset 4px 0 0 var(--lead-accent)
            }

            #playersTable tr.row-tied td {
                background: var(--tie);
                box-shadow: inset 4px 0 0 var(--tie-accent)
            }

        .playersGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
            gap: 8px
        }

        .playersGridItem {
            padding: 14px 16px;
            border-radius: 14px;
            color: #fff;
            text-align: center;
            min-height: 64px;
            display: grid;
            place-items: center;
            position: relative;
            box-shadow: 0 8px 16px rgba(0,0,0,.12);
            font-size: 15px
        }

            .playersGridItem[role="button"] {
                outline: none
            }

            .playersGridItem:focus-visible {
                box-shadow: 0 0 0 4px var(--ring)
            }

        .voters {
            font-size: 12px;
            margin-top: 6px;
            color: #fff;
            background: rgba(0,0,0,.25);
            border-radius: 10px;
            padding: 4px 6px
        }

        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            backdrop-filter: blur(2px);
            z-index: 40
        }

        #roleCard {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            background: #fff;
            padding: 22px;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,0,0,.25);
            text-align: center;
            z-index: 50;
            width: min(92vw,440px)
        }

            #roleCard h2 {
                font-size: 22px
            }

        #closeRoleCard {
            margin-top: 14px
        }

        .rolesGuideGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
            gap: 12px;
            margin-top: 8px
        }

        .roleCardMini {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 8px 16px rgba(0,0,0,.08);
            display: flex;
            flex-direction: column;
            gap: 6px
        }

            .roleCardMini .title {
                font-weight: 800;
                display: flex;
                align-items: center;
                gap: 8px
            }

            .roleCardMini .badge {
                font-size: 24px;
                line-height: 1
            }

            .roleCardMini .desc {
                font-size: 14px;
                color: var(--muted)
            }

        .countWrap {
            display: flex; /* da inline-flex -> flex */
            justify-content: space-between;
            align-items: baseline;
            flex-wrap: wrap; /* consenti a capo su mobile se serve */
            gap: 8px;
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 800;
            width: 100%; /* occupa tutta la riga */
            max-width: 100%;
            white-space: normal; /* niente overflow */
        }

        .count-left {
            font-weight: 800;
        }

        .count-right {
            margin-left: auto;
            font-weight: 800;
        }
        @media (max-width:560px) {
            .countWrap {
                justify-content: center;
                line-height: 1.2;
            }
                /* Metti â€œMancano: â€¦â€ a capo per guadagnare spazio */
                .countWrap .muted {
                    display: block;
                }
        }


            .countWrap .muted {
                color: var(--muted);
                font-weight: 600
            }

        .hostRow {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: baseline;
            margin: 6px 0
        }

            .hostRow code {
                background: #f8fafc;
                border: 1px solid var(--border);
                border-radius: 6px;
                padding: 2px 6px;
                font-family: ui-monospace,SFMono-Regular,Menlo,monospace;
                overflow-wrap: anywhere
            }

        @media (max-width:600px) {
            body {
                background: radial-gradient(1200px 800px at 50% -10%, #ffd0c2 0%, transparent 55%), radial-gradient(1000px 700px at 50% 110%, #ffe9b0 0%, transparent 55%), linear-gradient(135deg,#fff7f3 0%,#ffe9e3 35%,#fff6e6 100%)
            }
        }

        @media (max-width:560px) {
            .brandbar {
                padding-top: 14px
            }

            .brand-sub {
                font-size: 13px
            }

            .field-row {
                grid-template-columns: 1fr
            }

            .btn-row {
                grid-template-columns: 1fr
            }

            .login-card {
                padding: 18px
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important
            }
        }

        #nicoEasterEgg {
            display: none
        }

        #screenLobby {
            display: none
        }

            #screenLobby.active {
                display: flex;
                flex-direction: column;
                gap: 12px
            }

            #screenLobby .panel {
                margin: 0 auto
            }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0
        }
        .centered-heading {
            text-align: center;
        }
        /* Fai occupare al bottone tutta la riga della grid */
        .btn-row .btn-full {
            grid-column: 1 / -1; /* span su tutte le colonne */
            width: 100%; /* allunga il contenuto */
            justify-self: stretch; /* evita che resti centrato */
        }

    </style>
</head>
<body>
    <div class="app-shell">
        <header class="brandbar" aria-label="Intestazione">
            <div class="brand-mark" aria-hidden="true">ğŸº</div>
            <div>
                <div class="brand-title">Lupus in Fabula</div>
                <div class="brand-sub">Gioca con gli amici, ovunque.</div>
            </div>
        </header>


        <!-- ACCESSO -->
        <main id="screenAccess" class="screen active" aria-labelledby="accessoTitolo">
            <section class="login-card" role="group" aria-describedby="accessoHelp">
                <div class="login-hero">
                    <div class="login-hero-emoji" aria-hidden="true">ğŸ²</div>
                    <div>
                        <h2 id="accessoTitolo">Accesso</h2>
                        <p id="accessoHelp">Entra con il tuo nome e l'ID della stanza. BenvenutÉ™ al villaggio!</p>
                    </div>
                </div>

                <div class="field-row">
                    <input id="name" placeholder="Il tuo nome" aria-label="Nome" />
                    <input id="roomIdInput" placeholder="ID stanza" aria-label="ID Stanza" />
                </div>

                <div class="btn-row">
                    <button id="createBtn">ğŸª Crea stanza</button>
                    <button id="joinBtn">â¡ï¸ Unisciti</button>
                </div>

                <div class="helper">Se il server Ã¨ offline, vedrai un avviso. I bottoni restano usabili e provano a riconnettersi.</div>
            </section>
        </main>

        <!-- LOBBY -->
        <section id="screenLobby" class="screen" aria-labelledby="lobbyTitolo" aria-hidden="true" hidden>
            <div class="panel">
                <h2 id="lobbyTitolo">Lobby</h2>
                <p class="hostRow">
                    ğŸ‘‘ Host: <span id="hostNameText"></span>
                    &nbsp;â€¢&nbsp;
                    ğŸ·ï¸ ID: <code id="currentRoomIdText"></code>
                </p>

                <div id="inviteBox">
                    <p>Invita altri giocatori con questo link:</p>
                    <input id="inviteLink" type="text" readonly />
                    <div class="btn-row" style="margin-top:8px;">
                        <button onclick="copyInvite()">ğŸ“‹ Copia link</button>
                        <button class="btn-secondary" onclick="shareInvite()">ğŸ“¤ Condividi</button>
                    </div>
                </div>

                <div class="btn-row" style="margin-top:8px;">
                    <button class="btn-secondary" onclick="exitToLogin()">âï¸ Esci</button>
                </div>
            </div>

            <div class="panel">
                <h3 class="centered-heading">ğŸ‘¥ Giocatori connessi</h3>
                <div id="playerList"></div>
            </div>

            <!-- SOLO HOST -->
            <div id="hostControls" class="panel" style="display:none;">
                <h3 class="centered-heading">âš”ï¸ Imposta ruoli e avvia</h3>
                <div class="countWrap" style="margin:6px 0 12px;">
                    <span class="count-left">ğŸ‘¥ In stanza:<span id="playerCount">0</span></span>
                    <span class="muted">â€¢ Mancano: <strong id="rolesRemaining">0</strong></span>
                </div>

                <div class="rolesBox">
                    <div class="number-control" data-role="wolves"><label>ğŸº Lupi</label><span class="dec-btn" role="button" aria-label="Diminuisci lupi" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta lupi" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="villagers"><label>ğŸŒ¾ Contadini</label><span class="dec-btn" role="button" aria-label="Diminuisci contadini" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta contadini" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="guards"><label>ğŸ’‹ Puttane</label><span class="dec-btn" role="button" aria-label="Diminuisci puttane" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta puttane" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="seers"><label>ğŸ”® Veggenti</label><span class="dec-btn" role="button" aria-label="Diminuisci veggenti" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta veggenti" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="scemo"><label>ğŸ¦§ Scemo</label><span class="dec-btn" role="button" aria-label="Diminuisci scemo" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta scemo" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="hunter"><label>ğŸ¹ Cacciatore</label><span class="dec-btn" role="button" aria-label="Diminuisci cacciatore" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta cacciatore" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="witch"><label>ğŸ§ª Strega</label><span class="dec-btn" role="button" aria-label="Diminuisci strega" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta strega" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="lara"><label>ğŸŒ™ Lara</label><span class="dec-btn" role="button" aria-label="Diminuisci Lara" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta Lara" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="mayor"><label>ğŸ–ï¸ Sindaco</label><span class="dec-btn" role="button" aria-label="Diminuisci sindaco" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta sindaco" tabindex="0">â•</span></div>
                    <div class="number-control" data-role="hitman"><label>ğŸ”« Sicario</label><span class="dec-btn" role="button" aria-label="Diminuisci sicario" tabindex="0">â–</span><span class="count" aria-live="polite">0</span><span class="inc-btn" role="button" aria-label="Aumenta sicario" tabindex="0">â•</span></div>
                </div>

                <div class="btn-row" style="margin-top:10px;">
                    <button class="btn-full" onclick="startGame()">ğŸš€ Avvia partita</button>
                </div>
            </div>

            <div class="panel" id="rolesPanelHost">
                <h3>ğŸ“˜ Ruoli del gioco</h3>
                <div id="rolesGuideHost" class="rolesGuideGrid"></div>
            </div>

            <div class="panel" id="logPanelLobby">
                <h3>ğŸ“œ Log eventi</h3>
                <ul id="log" aria-live="polite"></ul>
            </div>
        </section>

        <!-- GIOCO HOST -->
        <section id="screenGame" class="screen" aria-labelledby="giocoHostTitolo" aria-hidden="true" hidden>
            <div class="panel">
                <h2 id="giocoHostTitolo" class="centered-heading">ğŸ² Partita in corso</h2>
                <p>ğŸ‘‘ Host: <span id="hostNameInGame"></span> &nbsp;â€¢&nbsp; ğŸ·ï¸ ID: <code id="roomIdInGame"></code></p>
               
                <h3 class="centered-heading">ğŸ‘¥ Giocatori e ruoli</h3>
                <table id="playersTable" border="0"></table>

                <div class="btn-row" style="margin-top:10px;">
                    <button id="votingBtn" onclick="toggleVoting()">Votazione</button>
                    <button id="restartBtn" class="btn-secondary" onclick="restartGame()">ğŸ”„ Restart</button>
                    <button class="btn-secondary" onclick="exitToLogin()">âï¸ Esci</button>
                </div>

                <h3 style="margin-top:14px;">ğŸ“œ Log eventi</h3>
                <ul id="gameLog" aria-live="polite"></ul>
            </div>
        </section>

        <!-- GIOCO GIOCATORI -->
        <section id="screenGamePlayer" class="screen" aria-labelledby="giocoPlayerTitolo" aria-hidden="true" hidden>
            <div class="panel">
                <h2 id="giocoPlayerTitolo" class="centered-heading">ğŸ² Partita in corso</h2>
                <p>ğŸ‘‘ Host: <span id="hostNamePlayer"></span></p>

                <h3 class="centered-heading">ğŸ‘¥ Giocatori</h3>
                <div id="playersGrid" class="playersGrid"></div>

                <button id="showRoleBtn" style="display:none; margin-top:10px;">Mostra ruolo</button>

                <h3 class="centered-heading">ğŸ“˜ Ruoli del gioco</h3>

                <div id="rolesGuidePlayer" class="rolesGuideGrid"></div>

                <div class="btn-row" style="margin-top:8px;">
                    <button class="btn-secondary" onclick="exitToLogin()">âï¸ Esci</button>
                </div>

                <h3 style="margin-top:14px;">ğŸ“œ Log eventi</h3>
                <ul id="gameLogPlayer" aria-live="polite"></ul>
            </div>
        </section>

        <!-- Overlay + Role Card -->
        <div id="overlay"></div>
        <div id="roleCard" role="dialog" aria-modal="true" aria-labelledby="roleTitle" aria-hidden="true">
            <h2 id="roleTitle">ğŸƒ Il tuo ruolo</h2>
            <img id="nicoEasterEgg" alt="nico-gay" src="images/easter-egg.png" />
            <p id="roleText">Nessun ruolo</p>
            <p id="roleDescription" style="margin-top:10px; font-style:italic; color:#555;">Descrizione</p>
            <button id="closeRoleCard">Chiudi</button>
        </div>

        <footer style="text-align:center; padding: 12px; color: var(--muted); font-size: 12.5px;">
            Â© Villaggio di Lupus â€” divertiti responsabilmente ğŸº
        </footer>
    </div>

    <script>
        function initApp() {
            if (!window.signalR) { console.error('SignalR non caricato'); return; }

            /* ====================== SignalR: setup ====================== */
            const connection = new signalR.HubConnectionBuilder()
                .withUrl(window.HUB_URL)
                .withAutomaticReconnect([0, 1000, 5000, 10000, 20000, 30000])
                .build();
            connection.serverTimeoutInMilliseconds = 120000;
            connection.keepAliveIntervalInMilliseconds = 15000;

            /* ====================== Stato globale ====================== */
            let currentRoomId = null, isHost = false, myRole = null, votingOpen = false, myVote = null, currentPlayers = [], gameStarted = false;
            let myName = null;

            const NAME_MAP = { "nico": "N1k0GgAY", "niko": "N1k0GgAY", "nicolo": "N1k0GgAY", "nicco": "N1k0GgAY", "gioia": "TriS5tezZa", "carly": "Carmine", "carlotta": "Carmine", "carli": "Carmine", "benni": "Benagol", "benny": "Benagol", "matte": "MaTTe0R0Li", "matteo": "MaTTe0R0Li" };
            const normalizeName = s => (s || "").trim().toLowerCase();
            const applyNameMapping = s => NAME_MAP[normalizeName(s || "")] || (s || "").trim();

            const roleNames = { wolf: "ğŸº Lupo", villager: "ğŸ‘¨â€ğŸŒ¾ Contadino", seer: "ğŸ”® Veggente", guard: "ğŸ’‹ Puttana", scemo: "ğŸ¦§ Scemo", hunter: "ğŸ¹ Cacciatore", witch: "ğŸ§ª Strega", lara: "ğŸŒ™ Lara", mayor: "ğŸ–ï¸ Sindaco", hitman: "ğŸ”« Sicario" };
            const roleDescriptions = {
                wolf: `Di notte scegliete insieme una vittima.\nVincete se i lupi eliminano tutti gli altri.`,
                villager: `Non hai poteri speciali.\nUsa l'astuzia per smascherare i lupi.`,
                seer: `Ogni notte puoi scoprire se un giocatore Ã¨ lupo.`,
                guard: `Ogni notte puoi proteggere un giocatore o te stessa\ndall'attacco dei lupi.`,
                scemo: `Vinci se vieni eliminato dai voti del villaggio.`,
                hunter: `Se vieni eliminato, puoi scegliere immediatamente\nun altro giocatore da portare con te.`,
                witch: `Hai due pozioni: una per salvare una vittima, una per uccidere.\nPuoi usarle solo una volta ciascuna.`,
                lara: `All'inizio sei una cittadina.\nSe vieni uccisa dai lupi, diventi un Lupo.\nVinci con i cittadini finchÃ© sei cittadina,\nma se diventi Lupo vinci con i lupi.`,
                mayor: `Durante le votazioni il tuo voto conta doppio.`,
                hitman: `Hai una pistola con un solo colpo.\nPuoi usarla una volta in tutta la partita per eliminare un giocatore.`
            };

            /* ====================== Riferimenti DOM ====================== */
            const overlay = document.getElementById("overlay");
            const roleCard = document.getElementById("roleCard");
            const closeRoleBtn = document.getElementById("closeRoleCard");
            const roleText = document.getElementById("roleText");
            const roleDescEl = document.getElementById("roleDescription");
            const nicoEE = document.getElementById("nicoEasterEgg");
            // Collega i bottoni della schermata di accesso
            const createBtn = document.getElementById("createBtn");
            const joinBtn = document.getElementById("joinBtn");

            createBtn?.addEventListener("click", createRoom);
            joinBtn?.addEventListener("click", joinRoom);

            // ComoditÃ : Enter nel campo ID stanza fa il join
            document.getElementById("roomIdInput")
                ?.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") joinRoom();
                });

            /* ====================== A11y: gestione modale ====================== */
            let lastFocused = null;
            function getFocusable(container) {
                return container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            }
            function openEasterEgg() { nicoEE.style.display = "block"; }
            function closeRoleCardEEFn() { nicoEE.style.display = "none"; }
            function openRoleCard() {
                overlay.style.display = "block";
                roleCard.style.display = "block";
                roleCard.setAttribute('aria-hidden', 'false');
                lastFocused = document.activeElement;
                const focusables = getFocusable(roleCard);
                (focusables[0] || closeRoleBtn).focus();
                roleCard._trap = (e) => {
                    if (e.key === 'Tab') {
                        const f = Array.from(getFocusable(roleCard));
                        const first = f[0], last = f[f.length - 1];
                        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                    }
                };
                roleCard.addEventListener('keydown', roleCard._trap);
            }
            function closeRoleCardFn() {overlay.style.display = "none";roleCard.style.display = "none";roleCard.setAttribute('aria-hidden', 'true');roleCard.removeEventListener('keydown', roleCard._trapcloseRoleCardEEFn();
                if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
            }
            closeRoleBtn.onclick = closeRoleCardFn; overlay.onclick = closeRoleCardFn;
            window.addEventListener("keydown", e => { if (e.key === "Escape") closeRoleCardFn(); });

            document.getElementById("showRoleBtn").onclick = () => {
                if (myRole) {
                    closeRoleCardEEFn();
                    roleText.textContent = roleNames[myRole] || myRole;
                    roleDescEl.textContent = roleDescriptions[myRole] || "Nessuna descrizione.";
                    openRoleCard();
                    const currName = (localStorage.getItem("lupus_name") || "");
                    if (["N1k0GgAY", "nicco"].includes(currName) || currName.toLowerCase().includes("nic")) openEasterEgg();
                } else alert("âŒ Nessun ruolo assegnato ancora.");
            };

            /* ====================== Connessione ====================== */
            function updateConnectionUI() {
                const connected = connection.state === signalR.HubConnectionState.Connected;
                const c = document.getElementById("createBtn"), j = document.getElementById("joinBtn");
                if (c) c.disabled = false;
                if (j) j.disabled = false;
            }

            async function ensureConnection({ silent = false } = {}) {
                if (connection.state === signalR.HubConnectionState.Connected) return true;
                try {
                    await connection.start();
                    logLobby("âœ… Connesso al server");
                    updateConnectionUI();
                    return true;
                } catch (err) {
                    console.error("Connessione fallita:", err);
                    logLobby("âŒ Server non raggiungibile (controlla percorso /gamehub). Riprova.");
                    updateConnectionUI();
                    return false;
                }
            }

            // Avvio soft (ma i bottoni non dipendono da questo)
            (async () => {
                try { await connection.start(); logLobby("âœ… Connesso al server"); }
                catch (e) { console.warn("Connessione iniziale fallita"); }
                finally { updateConnectionUI(); }
            })();

            connection.onreconnecting(updateConnectionUI);
            connection.onreconnected(() => {
                updateConnectionUI();
                const rid = localStorage.getItem("lupus_roomId");
                const nm = localStorage.getItem("lupus_name");
                const auto = localStorage.getItem("lupus_autoJoin") === "true";
                if (auto && rid && nm) joinRoom().catch(() => { });
            });
            connection.onclose(updateConnectionUI);

            /* Heartbeat */
            let hbTimer = null;
            function startHeartbeat() {
                if (hbTimer) return;
                hbTimer = setInterval(() => {
                    if (connection.state === signalR.HubConnectionState.Connected) {
                        connection.invoke("Heartbeat").catch(() => { });
                    }
                }, 20000);
            }
            function stopHeartbeat() { if (hbTimer) { clearInterval(hbTimer); hbTimer = null; } }

            function focusFirstInside(id) {
                const target = document.getElementById(id);
                if (!target) return;
                const el = target.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (el) el.focus();
            }

            function showScreen(id) {
                document.querySelectorAll(".screen").forEach(s => {
                    s.classList.remove("active"); s.setAttribute("aria-hidden", "true"); s.hidden = true;
                    if ("inert" in s) s.inert = true;
                });
                const target = document.getElementById(id);
                if (target) { target.classList.add("active"); target.removeAttribute("aria-hidden"); target.hidden = false; if ("inert" in target) target.inert = false; }
                if (id === "screenAccess") stopHeartbeat(); else startHeartbeat();
                focusFirstInside(id);
            }

            function logLobby(msg) {
                const logEl = document.getElementById("log"); if (!logEl) return;
                const li = document.createElement("li"); li.textContent = msg; logEl.appendChild(li);
                if (logEl.children.length > 80) logEl.removeChild(logEl.firstChild);
            }
            function logGame(msg) {
                const logEl = isHost ? document.getElementById("gameLog") : document.getElementById("gameLogPlayer"); if (!logEl) return;
                const li = document.createElement("li"); li.textContent = msg; logEl.appendChild(li);
                if (logEl.children.length > 80) logEl.removeChild(logEl.firstChild);
            }

            /* ====================== Helpers UI ====================== */
            function setRoomLabels() {
                const rid = currentRoomId || "";
                const ridHost = document.getElementById("roomIdInGame");
                const ridLobby = document.getElementById("currentRoomIdText");
                if (ridLobby) ridLobby.textContent = rid;
                if (ridHost) ridHost.textContent = rid;
            }
            function updateLobbyCounters(players) {
                const total = players.length;
                const totalEl = document.getElementById("playerCount");
                if (totalEl) totalEl.textContent = total;
                updateRolesLeft(total);
            }

            function renderRolesGuide(containerId) {
                const el = document.getElementById(containerId); if (!el) return;
                el.innerHTML = "";
                const order = ["wolf", "villager", "seer", "guard", "scemo", "hunter", "witch", "lara", "mayor", "hitman"];
                order.forEach(k => {
                    const card = document.createElement("div"); card.className = "roleCardMini";
                    const title = document.createElement("div"); title.className = "title";
                    const badge = document.createElement("span"); badge.className = "badge";
                    const rn = roleNames[k] || k; const maybeEmoji = rn.split(" ")[0];
                    badge.textContent = /\p{Extended_Pictographic}/u.test(maybeEmoji) ? maybeEmoji : "ğŸƒ";
                    const text = document.createElement("span"); text.textContent = rn;
                    const desc = document.createElement("div"); desc.className = "desc"; desc.textContent = roleDescriptions[k] || "";
                    title.appendChild(badge); title.appendChild(text);
                    card.appendChild(title); card.appendChild(desc);
                    el.appendChild(card);
                });
            }

                /* ====================== Eventi dal server ====================== */
                connection.on("UpdateLobby", (players, hostName) => {
                    updateConnectionUI();

                    (document.getElementById("hostNameText") || {}).textContent = hostName || "Sconosciuto";
                    (document.getElementById("hostNameInGame") || {}).textContent = hostName || "Sconosciuto";
                    (document.getElementById("hostNamePlayer") || {}).textContent = hostName || "Sconosciuto";

                    const list = document.getElementById("playerList");
                    if (list) {
                        list.innerHTML = "";
                        players.forEach(p => {
                            const pname = p.name ?? p.Name ?? "";
                            const online = (typeof p.isOnline === "boolean") ? p.isOnline : !!p.IsOnline;

                            const d = document.createElement("div");
                            d.classList.add("playerCard", online ? "online" : "offline");

                            const nameSpan = document.createElement("span");
                            nameSpan.textContent = `${ pname || "(sconosciuto)" } ${ online ? "" : "(offline)" } `;
                            d.appendChild(nameSpan);

                            // Mostra la X solo se host, in lobby, e con un nome valido
                            if (isHost && !gameStarted && pname) {
                                const btn = document.createElement("button");
                                btn.className = "kickBtn";
                                btn.title = `Espelli ${ pname } `;
                                btn.textContent = "âœ–";
                                btn.addEventListener('click', () => kickPlayer(pname));
                                d.appendChild(btn);
                            }

                            list.appendChild(d);
                        });
                    }

                    updateLobbyCounters(players);
                    renderRolesGuide("rolesGuideHost");

                    if (!gameStarted) showScreen("screenLobby");
                    refreshInviteUI(currentRoomId);
                    setRoomLabels();
                });

            connection.on("JoinError", (msg) => {
                // niente alert automatico: solo log in lobby
                logLobby(`âŒ ${msg}`);
            });

                connection.on("ReceiveRole", role => {
                    myRole = role;
                    const btn = document.getElementById("showRoleBtn");
                    if (btn) btn.style.display = "inline-block";
                });

                connection.on("VotingStarted", () => {
                    votingOpen = true; logGame("ğŸ—³ï¸ Votazioni aperte!");
                    renderPlayers(currentPlayers);
                    if (isHost) {
                        const btn = document.getElementById("votingBtn");
                        if (btn) { btn.style.backgroundColor = "#4A90E2"; btn.textContent = "Il dado Ã¨ tratto"; }
                    }
                });

                connection.on("VotingEnded", () => {
                    votingOpen = false; myVote = null; logGame("ğŸ›‘ Votazioni chiuse!");
                    renderPlayers(currentPlayers);
                    if (isHost) {
                        const btn = document.getElementById("votingBtn");
                        if (btn) { btn.style.backgroundColor = "var(--brand)"; btn.textContent = "Votazione"; }
                    }
                });

                connection.on("UpdateVotes", (players) => {
                    currentPlayers = players || [];

                    if (myName) {
                        let mine = null;
                        for (const p of currentPlayers) {
                            if (!p.eliminated && Array.isArray(p.votedBy) && p.votedBy.includes(myName)) { mine = p.name; break; }
                        }
                        myVote = mine;
                    }

                    renderPlayers(currentPlayers);
                    if (isHost) renderHostTable(currentPlayers);
                });

                connection.on("PlayerKicked", (playerName) => {
                    logLobby(`ğŸš« ${ playerName } Ã¨ stato espulso dall'host.`);
        });

        connection.on("PlayerEliminated", (playerName) => {
            const player = currentPlayers.find(p => p.name === playerName);
            if (player) player.eliminated = true;
            if (myVote === playerName) myVote = null;
            renderHostTable(currentPlayers);
            renderPlayers(currentPlayers);
            logGame(`âš°ï¸ ${playerName} Ã¨ stato eliminato!`);
        });

        connection.on("GameRestarted", (players, hostName) => {
            gameStarted = false; votingOpen = false; myVote = null; myRole = null; currentPlayers = players || [];
            overlay.style.display = "none"; roleCard.style.display = "none";
            const roleBtn = document.getElementById("showRoleBtn"); if (roleBtn) roleBtn.style.display = "none";

            (document.getElementById("hostNameText") || {}).textContent = hostName || "Sconosciuto";
            (document.getElementById("hostNameInGame") || {}).textContent = hostName || "Sconosciuto";
            (document.getElementById("hostNamePlayer") || {}).textContent = hostName || "Sconosciuto";
            (document.getElementById("currentRoomIdText") || {}).textContent = currentRoomId || "";

            const list = document.getElementById("playerList");
            if (list) {
                list.innerHTML = "";
                (players || []).forEach(p => {
                    const pname = p.name ?? p.Name ?? "";
                    const online = (typeof p.isOnline === "boolean") ? p.isOnline : !!p.IsOnline;
                    const d = document.createElement("div");
                    d.classList.add("playerCard", online ? "online" : "offline");
                    d.textContent = `${pname} ${online ? "" : "(offline)"}`;
                    list.appendChild(d);
                });
            }

            (document.getElementById("playersGrid") || {}).innerHTML = "";
            (document.getElementById("gameLog") || {}).innerHTML = "";
            (document.getElementById("gameLogPlayer") || {}).innerHTML = "";
            (document.getElementById("playersTable") || {}).innerHTML = "";

            updateLobbyCounters(players || []);
            showScreen("screenLobby");
            const hostCtrls = document.getElementById("hostControls");
            if (isHost && hostCtrls) hostCtrls.style.display = "block";
            const btn = document.getElementById("votingBtn");
            if (btn) { btn.style.backgroundColor = "var(--brand)"; btn.textContent = "Votazione"; btn.title = "Apri votazioni"; }

            logLobby("ğŸ”„ La partita Ã¨ stata riavviata, siete tornati in lobby.");
            refreshInviteUI(currentRoomId); renderRolesGuide("rolesGuideHost"); setRoomLabels();
        });

        connection.on("GameStarted", (players) => {
            gameStarted = true; myVote = null; currentPlayers = players || [];

            if (!isHost) {
                const grid = document.getElementById("playersGrid");
                const gl = document.getElementById("gameLogPlayer");
                if (grid) grid.innerHTML = "";
                if (gl) gl.innerHTML = "";
            }

            if (isHost) { showScreen("screenGame"); renderHostTable(currentPlayers); }
            else { showScreen("screenGamePlayer"); renderPlayers(currentPlayers); renderRolesGuide("rolesGuidePlayer"); }

            refreshInviteUI(currentRoomId);
            setRoomLabels();
        });

        connection.on("ReceiveHostKey", (hostKey) => { localStorage.setItem("lupus_hostKey", hostKey); });

        connection.on("Kicked", () => {
            alert("Sei stato espulso dalla stanza dall'host.");
            exitToLogin();
        });

        /* ====================== Render Host Table (XSS-safe) ====================== */
        function renderHostTable(players) {
            const table = document.querySelector("#playersTable"); if (!table) return;
            table.innerHTML = "";

            const header = document.createElement("tr");
            ["Nome", "Ruolo", "Stato", "Voti", "Azioni"].forEach(h => { const th = document.createElement("th"); th.textContent = h; header.appendChild(th); });
            table.appendChild(header);

            const votes = players.filter(p => !p.eliminated).map(p => p.votes || 0);
            const maxVotes = votes.length ? Math.max(...votes) : 0;
            const leaders = players.filter(p => !p.eliminated && (p.votes || 0) === maxVotes);
            const isTie = (maxVotes > 0 && leaders.length > 1);

            players.forEach(p => {
                const tr = document.createElement("tr");
                if (maxVotes > 0 && !p.eliminated && (p.votes || 0) === maxVotes) tr.className = isTie ? "row-tied" : "row-leader";

                const tdName = document.createElement("td");
                const nameDisplay = p.eliminated ? `â˜ ï¸ ${p.name}` : p.name;
                if (p.eliminated) { tdName.style.color = 'gray'; tdName.style.textDecoration = 'line-through'; }
                tdName.appendChild(document.createTextNode(nameDisplay));

                const tdRole = document.createElement("td"); tdRole.textContent = p.role ? (roleNames[p.role] || p.role) : "";

                const tdStatus = document.createElement("td");
                tdStatus.textContent = p.isOnline ? 'Online' : 'Offline';
                tdStatus.style.color = p.isOnline ? 'green' : 'red';

                const tdVotes = document.createElement("td"); tdVotes.textContent = String(p.votes || 0);

                const tdActions = document.createElement("td");
                if (!p.eliminated) {
                    const btn = document.createElement("button");
                    btn.textContent = 'Elimina';
                    btn.addEventListener('click', () => eliminatePlayer(p.name));
                    tdActions.appendChild(btn);
                }

                tr.append(tdName, tdRole, tdStatus, tdVotes, tdActions);
                table.appendChild(tr);
            });
        }

        /* ====================== Render griglia giocatori (client) ====================== */
        function renderPlayers(players) {
            const container = document.getElementById("playersGrid"); if (!container) return;
            container.innerHTML = "";

            players.forEach(p => {
                const card = document.createElement("div");
                card.className = "playersGridItem";

                let displayName = p.eliminated ? `â˜ ï¸ ${p.name}` : p.name;
                if (p.role === "mayor") displayName += " ğŸ–ï¸";
                const baseText = (!p.eliminated && p.votes > 0) ? `${displayName} (${p.votes})` : displayName;
                card.textContent = baseText;

                const isMyPick = (myVote === p.name);
                card.style.backgroundColor = p.eliminated ? "#9ca3af" : (votingOpen ? (isMyPick ? "#f59e0b" : "#4A90E2") : "#6b7280");
                card.style.cursor = (votingOpen && !p.eliminated) ? "pointer" : "default";
                card.style.opacity = p.isOnline ? "1" : ".7";

                if (votingOpen && !p.eliminated) {
                    card.setAttribute('role', 'button');
                    card.tabIndex = 0;
                    card.title = isMyPick ? "Riclicca per togliere il voto" : "Clicca per votare";
                    card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); } });
                } else {
                    card.removeAttribute('role');
                    card.removeAttribute('tabindex');
                    card.removeAttribute('title');
                }

                if (Array.isArray(p.votedBy) && p.votedBy.length > 0) {
                    const votersList = document.createElement("div"); votersList.className = "voters";
                    const title = document.createElement("div"); title.textContent = "Votato da:"; votersList.appendChild(title);
                    const ul = document.createElement("ul"); ul.style.margin = "4px 0 0"; ul.style.padding = "0"; ul.style.listStyle = "none";
                    p.votedBy.forEach(name => { const li = document.createElement("li"); li.textContent = name; ul.appendChild(li); });
                    votersList.appendChild(ul);
                    card.appendChild(votersList);
                }

                if (votingOpen && !p.eliminated) {
                    card.onclick = async () => {
                        const prev = myVote;
                        if (myVote === p.name) {
                            myVote = null; renderPlayers(currentPlayers);
                            try {
                                try { await connection.invoke("UnvotePlayer", currentRoomId); }
                                catch (_) { try { await connection.invoke("VotePlayer", currentRoomId, null); } catch (_) { await connection.invoke("VotePlayer", currentRoomId, ""); } }
                            } catch (e) { console.error("Unvote fallito:", e); myVote = prev; renderPlayers(currentPlayers); }
                            return;
                        }
                        myVote = p.name; renderPlayers(currentPlayers);
                        try { await connection.invoke("VotePlayer", currentRoomId, p.name); }
                        catch (e) { console.error("Vote fallito:", e); myVote = prev; renderPlayers(currentPlayers); }
                    };
                } else {
                    card.onclick = null;
                }

                container.appendChild(card);
            });
        }

        /* ====================== Azioni base ====================== */
        function readRoleCounts() {
            const counts = {};
            document.querySelectorAll(".rolesBox .number-control").forEach(ctrl => {
                const key = ctrl.dataset.role;
                const val = parseInt(ctrl.querySelector(".count").textContent) || 0;
                counts[key] = val;
            });
            return counts;
        }
        function calcAssignedRoles() {
            const counts = readRoleCounts();
            return Object.values(counts).reduce((a, b) => a + (parseInt(b) || 0), 0);
        }
        function updateRolesLeft(totalPlayersOverride = null) {
            const totalPlayers = (typeof totalPlayersOverride === 'number') ? totalPlayersOverride : (parseInt(document.getElementById("playerCount")?.textContent) || 0);
            const assigned = calcAssignedRoles();
            const left = Math.max(0, totalPlayers - assigned);
            const el = document.getElementById("rolesRemaining");
            if (el) el.textContent = String(left);
        }

        async function createRoom() {
            const rawName = document.getElementById("name").value || "Host";
            const name = applyNameMapping(rawName);
            myName = name; isHost = true;

            const ok = await ensureConnection();
            if (!ok) { alert("Server non raggiungibile. Verifica che /gamehub sia mappato sul server."); return; }

            try {
                const id = await connection.invoke("CreateRoom", name);
                currentRoomId = id;
                localStorage.setItem("lupus_roomId", id);
                localStorage.setItem("lupus_name", name);
                localStorage.setItem("lupus_autoJoin", "true");

                (document.getElementById("hostNameText") || {}).textContent = name;
                setRoomLabels();
                logLobby(`ğŸª Stanza creata: ${currentRoomId}`);

                showScreen("screenLobby");
                const hc = document.getElementById("hostControls"); if (hc) hc.style.display = "block";
                renderRolesGuide("rolesGuideHost");
                refreshInviteUI(currentRoomId);
            } catch (err) {
                console.error(err);
                logLobby("âŒ Errore nella creazione della stanza");
                alert("Errore nella creazione della stanza");
            }
        }

        async function joinRoom() {
            const rawName = document.getElementById("name").value || "Giocatore";
            const name = applyNameMapping(rawName);
            myName = name;
            const roomId = (document.getElementById("roomIdInput").value || "").trim(); // <-- niente .toUpperCase()
            if (!roomId) { alert("Inserisci l'ID stanza"); return; }

            const ok = await ensureConnection();
            if (!ok) { logLobby("âŒ Non connesso al server."); return; }

            currentRoomId = roomId; myRole = null; votingOpen = false; myVote = null;

            const savedHostName = (localStorage.getItem("lupus_name") || "").trim().toLowerCase();
            const hostKey = localStorage.getItem("lupus_hostKey") || null;
            const isHostName = (name.trim().toLowerCase() === savedHostName);
            const hostKeyToSend = isHostName ? hostKey : null;

            try {
                const result = await connection.invoke("JoinRoom", roomId, name, hostKeyToSend);
                if (result && result.ok === false) { alert(result.error || "Impossibile entrare nella stanza."); return; }

                isHost = !!result.isHost; myRole = result.role || null; currentPlayers = result.players || [];
                votingOpen = !!result.votingOpen; gameStarted = !!result.gameStarted;

                localStorage.setItem("lupus_roomId", currentRoomId);
                localStorage.setItem("lupus_name", name);
                localStorage.setItem("lupus_autoJoin", "true");

                if (isHost) {
                    if (gameStarted) { showScreen("screenGame"); renderHostTable(currentPlayers); }
                    else { showScreen("screenLobby"); const hostCtrls = document.getElementById("hostControls"); if (hostCtrls) hostCtrls.style.display = "block"; }
                    const btn = document.getElementById("votingBtn");
                    if (btn) { if (votingOpen) { btn.style.backgroundColor = "#4A90E2"; btn.textContent = "Il dado Ã¨ tratto"; } else { btn.style.backgroundColor = "var(--brand)"; btn.textContent = "Votazione"; } }
                } else if (gameStarted) {
                    showScreen("screenGamePlayer"); renderPlayers(currentPlayers);
                } else {
                    showScreen("screenLobby");
                }

                if (myRole) { const roleBtn = document.getElementById("showRoleBtn"); if (roleBtn) roleBtn.style.display = "inline-block"; }

                updateLobbyCounters(result.players || []);
                setRoomLabels(); refreshInviteUI(currentRoomId); updateConnectionUI();
            } catch (err) {
                console.error(err);
                logLobby("âŒ Errore durante il join");
            }
        }

        async function startGame() {
            if (!isHost) { alert("âŒ Solo l'host puÃ² avviare la partita!"); return; }
            const r = readRoleCounts();
            const totalRoles = Object.values(r).reduce((a, b) => a + b, 0);
            if (totalRoles < currentPlayers.length) { alert("âŒ Ruoli insufficienti!"); return; }

            try {
                await connection.invoke("StartGame", currentRoomId, r.wolves, r.villagers, r.seers, r.guards, r.scemo, r.hunter, r.witch, r.lara, r.mayor, r.hitman);
                logLobby("ğŸš€ Partita avviata!");
            } catch (err) { console.error(err); logLobby("âŒ Errore nell'avvio della partita"); }
        }

        async function restartGame() {
            if (!isHost) return;
            if (!confirm("Vuoi davvero riavviare la partita e tornare in lobby?")) return;
            try { await connection.invoke("RestartGame", currentRoomId); }
            catch (err) { console.error(err); alert("Errore durante il riavvio della partita"); }
        }

        function toggleVoting() {
            if (!isHost) return;
            if (!votingOpen) connection.invoke("OpenVoting", currentRoomId).catch(console.error);
            else connection.invoke("CloseVoting", currentRoomId).catch(console.error);
        }

        async function eliminatePlayer(playerName) {
            if (!isHost) return;
            if (!confirm(`Sei sicuro di eliminare ${playerName}?`)) return;
            try { await connection.invoke("EliminatePlayer", currentRoomId, playerName); }
            catch (err) { console.error(err); alert("Errore durante l'eliminazione"); }
        }

        async function kickPlayer(playerName) {
            if (!isHost || gameStarted) return; // kick solo in lobby (coerente col server)
            if (!playerName) return;
            if (!confirm(`Vuoi espellere ${playerName} dalla stanza?`)) return;
            try {
                await connection.invoke("KickPlayer", currentRoomId, playerName);
                logLobby(`ğŸš« Hai espulso ${playerName}`);
            } catch (err) { console.error(err); alert("Errore durante l'espulsione"); }
        }

        /* ====================== Invite (lobby) ====================== */
        function refreshInviteUI(roomId) {
            const link = roomId ? `${window.location.origin}${window.location.pathname}?roomId=${encodeURIComponent(roomId)}` : '';
            const box = document.getElementById('inviteBox');
            const input = document.getElementById('inviteLink');
            if (roomId) { if (box) box.style.display = 'block'; if (input) input.value = link; }
            else { if (box) box.style.display = 'none'; }
        }
        function copyInvite() {
            const input = document.getElementById('inviteLink'); if (!input) return;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(input.value).then(() => alert('ğŸ“‹ Link copiato!')).catch(() => fallbackCopy(input));
            } else fallbackCopy(input);
        }
        function fallbackCopy(input) {
            const tmp = document.createElement('textarea'); tmp.value = input.value; tmp.style.position = 'absolute'; tmp.style.left = '-9999px';
            document.body.appendChild(tmp); tmp.select();
            try { const ok = document.execCommand('copy'); alert(ok ? 'ğŸ“‹ Link copiato!' : 'âš ï¸ Copia manuale'); }
            catch { alert('âš ï¸ Copia manuale'); }
            document.body.removeChild(tmp);
        }
        function shareInvite() {
            const input = document.getElementById('inviteLink'); if (!input) return;
            const link = input.value;
            if (navigator.share) navigator.share({ title: 'Invito Lupus in Tabula', text: 'Entra nella mia stanza!', url: link }).catch(() => { });
            else alert('Copia il link manualmente: ' + link);
        }

        /* ====================== Prefill + Auto-join ====================== */
        window.addEventListener("load", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomIdFromLink = urlParams.get("roomId");

            const nameInput = document.getElementById("name");
            const roomInput = document.getElementById("roomIdInput");

            const ridLS = localStorage.getItem("lupus_roomId");
            const nmLS = localStorage.getItem("lupus_name");
            const auto = localStorage.getItem("lupus_autoJoin") === "true";

            if (nmLS) nameInput.value = nmLS;
            if (roomIdFromLink) { roomInput.value = roomIdFromLink; logLobby(`ğŸ”— Sei stato invitato alla stanza: ${roomIdFromLink}`); }
            else if (ridLS) { roomInput.value = ridLS; }

            document.querySelectorAll(".rolesBox .number-control").forEach(ctrl => {
                const dec = ctrl.querySelector(".dec-btn"), inc = ctrl.querySelector(".inc-btn"), cnt = ctrl.querySelector(".count");
                const get = () => parseInt(cnt.textContent) || 0;
                const decHandler = () => { cnt.textContent = Math.max(0, get() - 1); updateRolesLeft(); };
                const incHandler = () => { cnt.textContent = get() + 1; updateRolesLeft(); };
                dec?.addEventListener("click", decHandler);
                inc?.addEventListener("click", incHandler);
                updateRolesLeft();
                // supporto tastiera
                dec?.addEventListener("keydown", (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); decHandler(); } });
                inc?.addEventListener("keydown", (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); incHandler(); } });
            });

            renderRolesGuide("rolesGuideHost");

            const wantAutoJoin = auto && nameInput.value.trim() && roomInput.value.trim();
            if (wantAutoJoin) {
                const tryJoin = async () => {
                    const ok = await ensureConnection();
                    if (!ok) { setTimeout(tryJoin, 1200); return; }
                    try { await joinRoom(); } catch { setTimeout(tryJoin, 1500); }
                };
                tryJoin();
            } else {
                updateConnectionUI();
            }
        });

        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) {
                ensureConnection();
                const rid = localStorage.getItem("lupus_roomId");
                const nm = localStorage.getItem("lupus_name");
                const auto = localStorage.getItem("lupus_autoJoin") === "true";
                if (auto && rid && nm) joinRoom().catch(() => { });
            }
        });

        /* ====================== Esci ====================== */
        async function exitToLogin() {
            try { if (currentRoomId) { try { await connection.invoke('LeaveRoom', currentRoomId); } catch { } } } catch { }
            try { await connection.stop(); } catch { }

            currentRoomId = null;
            isHost = false;
            myRole = null;
            votingOpen = false;
            myVote = null;
            gameStarted = false;

            // Pulisci storage per evitare auto-join indesiderato
            localStorage.removeItem('lupus_roomId');
            localStorage.setItem('lupus_autoJoin', 'false');

            showScreen('screenAccess');
            updateConnectionUI();
        }

            /* ====================== Export per gli onclick inline ====================== */
            Object.assign(window, {
                createRoom,
                joinRoom,
                startGame,
                toggleVoting,
                restartGame,
                exitToLogin,
                eliminatePlayer,
                kickPlayer,
                copyInvite,
                shareInvite,
            });
        }
    </script>
</body>
</html>
